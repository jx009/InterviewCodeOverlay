# 支付系统集成说明

## 📋 概述

本文档介绍了独立支付模块的第一阶段开发完成情况，包括数据库设计、基础架构、配置管理和微信支付SDK集成。

## 🗄️ 数据库设计

### 新增表结构

#### 1. 支付订单表 (`payment_orders`)
```sql
- id: 主键
- order_no: 系统订单号 (唯一)
- out_trade_no: 商户订单号 (唯一)
- user_id: 用户ID (外键)
- amount: 支付金额 (元)
- points: 充值积分数量
- bonus_points: 赠送积分
- payment_method: 支付方式 (WECHAT_PAY/ALIPAY)
- payment_status: 支付状态 (PENDING/PAID/FAILED/CANCELLED/REFUNDED/EXPIRED)
- transaction_id: 第三方交易ID
- payment_time: 支付完成时间
- notify_time: 回调通知时间
- expire_time: 订单过期时间
- package_id: 关联套餐ID
- metadata: 订单元数据 (JSON)
- fail_reason: 失败原因
```

#### 2. 支付套餐表 (`payment_packages`)
```sql
- id: 主键
- name: 套餐名称
- description: 套餐描述
- amount: 价格 (元)
- points: 获得积分
- bonus_points: 赠送积分
- is_active: 是否启用
- sort_order: 排序权重
- icon: 套餐图标
- tags: 标签 (JSON)
- is_recommended: 是否推荐
```

#### 3. 支付回调日志表 (`payment_notify_logs`)
```sql
- id: 主键
- order_no: 订单号
- payment_method: 支付方式
- notify_type: 通知类型
- request_body: 回调请求体
- request_headers: 请求头 (JSON)
- response_status: 响应状态码
- process_status: 处理状态 (PENDING/SUCCESS/FAILED)
- error_message: 错误信息
- process_time: 处理时间
- retry_count: 重试次数
```

## 🏗️ 架构设计

### 目录结构
```
backend/src/payment/
├── config/
│   ├── payment-config.ts     # 支付通用配置
│   └── wechat-config.ts      # 微信支付配置
├── utils/
│   ├── wechat-crypto.ts      # 微信支付加密工具
│   └── payment-validator.ts  # 支付参数验证
├── scripts/
│   └── init-payment-packages.ts  # 初始化套餐脚本
└── types/
    └── payment.ts            # 支付相关类型定义
```

### 核心组件

#### 1. 配置管理 (`payment-config.ts`)
- 支付业务配置
- 环境变量管理
- 订单号生成
- 金额和积分验证
- 默认套餐配置

#### 2. 微信支付工具 (`wechat-crypto.ts`)
- RSA签名生成和验证
- AES加密解密
- 证书管理
- 回调验证
- 请求头生成

#### 3. 参数验证 (`payment-validator.ts`)
- 创建订单参数验证
- 订单号格式验证
- 支付状态验证
- 套餐参数验证
- 退款参数验证
- 分页参数验证

## 🔧 配置说明

### 环境变量配置

复制 `env.payment.example` 文件为 `.env` 并配置以下参数：

```bash
# 微信支付配置
WECHAT_PAY_APP_ID=your_wechat_app_id
WECHAT_PAY_MCH_ID=your_merchant_id
WECHAT_PAY_API_KEY=your_api_key_v2
WECHAT_PAY_API_V3_KEY=your_api_v3_key
WECHAT_PAY_CERT_PATH=./certs/apiclient_cert.pem
WECHAT_PAY_KEY_PATH=./certs/apiclient_key.pem
WECHAT_PAY_SERIAL_NO=your_certificate_serial_number
WECHAT_PAY_NOTIFY_URL=https://yourdomain.com/api/payment/notify/wechat

# 支付业务配置
PAYMENT_ORDER_EXPIRE_MINUTES=15
PAYMENT_MIN_AMOUNT=1
PAYMENT_MAX_AMOUNT=1000
PAYMENT_MIN_POINTS=10
PAYMENT_MAX_POINTS=10000
PAYMENT_POINTS_RATE=10
```

### 证书文件

需要在 `backend/certs/` 目录下放置微信支付证书：
- `apiclient_cert.pem` - 商户证书
- `apiclient_key.pem` - 商户私钥

## 📦 依赖安装

已安装的新依赖：
```bash
npm install wechatpay-node-v3 node-rsa
npm install --save-dev @types/node-rsa
```

## 🚀 初始化

### 1. 数据库迁移
```bash
npx prisma migrate dev --name add_payment_system
npx prisma generate
```

### 2. 初始化支付套餐
```bash
npx ts-node src/payment/scripts/init-payment-packages.ts
```

默认创建的套餐：
- 基础套餐: 10元 = 100积分
- 标准套餐: 30元 = 300积分 + 30赠送积分 (推荐)
- 高级套餐: 50元 = 500积分 + 100赠送积分  
- 旗舰套餐: 100元 = 1000积分 + 300赠送积分

## 🔒 安全设计

### 1. 数据安全
- 敏感配置使用环境变量
- 微信支付证书文件权限控制
- 订单号使用时间戳+随机数生成
- 支付金额二次验证

### 2. 加密安全
- RSA-SHA256签名算法
- AES-256-GCM加密
- 证书序列号验证
- 时间戳防重放攻击

### 3. 参数验证
- 严格的输入参数验证
- 订单号格式验证
- 金额范围限制
- 积分数量验证

## 📊 类型定义

### 主要接口
- `PaymentOrder` - 支付订单
- `PaymentPackage` - 支付套餐
- `CreateOrderRequest` - 创建订单请求
- `WechatPayData` - 微信支付数据
- `NotifyResult` - 回调处理结果

### 枚举类型
- `PaymentMethod` - 支付方式
- `PaymentStatus` - 支付状态
- `NotifyStatus` - 通知状态

## 🧪 测试验证

### 1. 数据库连接测试
```bash
npx prisma studio
```

### 2. 套餐数据验证
检查 `payment_packages` 表是否正确创建了默认套餐。

### 3. 配置验证
确保所有环境变量正确配置，特别是微信支付相关配置。

## 📋 下一步计划

第一阶段已完成：
- ✅ 数据库表设计和迁移
- ✅ 基础类型定义和配置
- ✅ 微信支付SDK集成
- ✅ 加密工具和参数验证

第二阶段计划：
- 🔄 微信支付服务实现
- 🔄 订单管理逻辑
- 🔄 支付回调处理机制
- 🔄 积分充值逻辑

## ⚠️ 注意事项

1. **证书安全**: 微信支付证书文件需要妥善保管，不要提交到版本控制系统
2. **环境配置**: 生产环境和开发环境需要使用不同的微信支付配置
3. **域名配置**: 回调地址必须是已备案的域名，且支持HTTPS
4. **测试环境**: 建议先在微信支付沙箱环境进行测试

## 🔗 相关文档

- [微信支付开发文档](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [Prisma文档](https://www.prisma.io/docs/)
- [Node.js加密模块文档](https://nodejs.org/api/crypto.html)

---

**支付系统第一阶段开发完成** ✅

如有问题，请查看日志或联系开发团队。 