# æ•°æ®åº“å¯åŠ¨å¤±è´¥ä¿®å¤æŒ‡å—

## é—®é¢˜æè¿°
æœåŠ¡å™¨å¯åŠ¨æ—¶å‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š
```
âŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: TypeError: Cannot read properties of undefined (reading 'findUnique')
```

## é—®é¢˜åŸå› 
Databaseç±»çš„æ„é€ å‡½æ•°ä¸­åŒæ­¥è°ƒç”¨äº†`this.init()`ï¼Œå¯¼è‡´Prismaå®¢æˆ·ç«¯è¿˜æœªå®Œå…¨åˆå§‹åŒ–å°±è¢«ä½¿ç”¨ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. ä¿®å¤database.jsæ–‡ä»¶

å°†database.jsæ–‡ä»¶ä¸­çš„æ„é€ å‡½æ•°ä¿®æ”¹ä¸ºï¼š

```javascript
class Database {
  constructor() {
    console.log('ğŸ“ Databaseæ„é€ å‡½æ•°å¼€å§‹...');
    try {
      this.prisma = new PrismaClient({
        log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
      });
      console.log('âœ… PrismaClientå®ä¾‹åˆ›å»ºæˆåŠŸ');
      console.log('ğŸ” this.prismaç±»å‹:', typeof this.prisma);
    } catch (error) {
      console.error('âŒ PrismaClientå®ä¾‹åˆ›å»ºå¤±è´¥:', error);
      throw error;
    }
  }
  
  // æ³¨æ„ï¼šæ„é€ å‡½æ•°ä¸­ä¸å†è°ƒç”¨ this.init()
```

### 2. ä¿®å¤server-simple.jsæ–‡ä»¶

åœ¨server-simple.jsä¸­çš„initializeServiceså‡½æ•°é‡Œæ·»åŠ æ•°æ®åº“åˆå§‹åŒ–ï¼š

```javascript
// åˆå§‹åŒ–æœåŠ¡
async function initializeServices() {
  try {
    initEmailService();
    await initRedis();
    await db.init(); // ğŸ”§ æ·»åŠ æ•°æ®åº“åˆå§‹åŒ–
    console.log('âœ… æ‰€æœ‰æœåŠ¡åˆå§‹åŒ–å®Œæˆ');
  } catch (error) {
    console.error('âŒ æœåŠ¡åˆå§‹åŒ–å¤±è´¥:', error);
    process.exit(1);
  }
}
```

### 3. ç¯å¢ƒå˜é‡é…ç½®

æ ¹æ®ä½ æä¾›çš„å¾®ä¿¡æ”¯ä»˜ä¿¡æ¯ï¼Œéœ€è¦åœ¨ç¯å¢ƒå˜é‡æˆ–.envæ–‡ä»¶ä¸­è®¾ç½®ï¼š

```bash
WECHAT_PAY_MCH_ID=1608730981
WECHAT_PAY_APP_ID=ä½ çš„çœŸå®APPIDï¼ˆæ›¿æ¢APPIDï¼‰
WECHAT_PAY_API_KEY=Aa111111111122222222223333333333
```

### 4. è¿è¡Œä¿®å¤è„šæœ¬

æˆ‘å·²ç»åˆ›å»ºäº†ä¿®å¤è„šæœ¬ `fix-database-init.js`ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œæ¥éªŒè¯æ•°æ®åº“è¿æ¥ï¼š

```bash
node fix-database-init.js
```

## éªŒè¯ä¿®å¤

1. è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯ï¼š
```bash
node test-database-debug.js
```

2. å¯åŠ¨æœåŠ¡å™¨ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
ğŸ“ Databaseæ„é€ å‡½æ•°å¼€å§‹...
âœ… PrismaClientå®ä¾‹åˆ›å»ºæˆåŠŸ
âœ… MySQLæ•°æ®åº“è¿æ¥æˆåŠŸ
âœ… æ‰€æœ‰æœåŠ¡åˆå§‹åŒ–å®Œæˆ
```

## æ³¨æ„äº‹é¡¹

1. ç¡®ä¿æœåŠ¡å™¨ä¸Šçš„ä»£ç æ–‡ä»¶å·²æ›´æ–°
2. é‡å¯æœåŠ¡å™¨ä½¿ä¿®æ”¹ç”Ÿæ•ˆ
3. æ£€æŸ¥æ•°æ®åº“è¿æ¥é…ç½®æ˜¯å¦æ­£ç¡®
4. ç¡®è®¤Prismaå®¢æˆ·ç«¯ç‰ˆæœ¬å…¼å®¹æ€§

ä¿®å¤å®Œæˆåï¼ŒæœåŠ¡å™¨åº”è¯¥èƒ½æ­£å¸¸å¯åŠ¨å¹¶æˆåŠŸåˆå§‹åŒ–æ•°æ®åº“ã€‚