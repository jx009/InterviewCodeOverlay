// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique @db.VarChar(50)
  email     String?  @unique @db.VarChar(100)
  password  String   @db.VarChar(255)
  isActive  Boolean  @default(true)
  points    Int      @default(100) // ç”¨æˆ·ç§¯åˆ†ä½™é¢ï¼Œæ–°ç”¨æˆ·é»˜è®¤100ç§¯åˆ†
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  config       UserConfig?
  usage        UsageRecord[]
  sessions     UserSession[]
  transactions PointTransaction[] // ç§¯åˆ†äº¤æ˜“è®°å½•

  @@map("users")
}

model UserConfig {
  id               Int      @id @default(autoincrement())
  userId           Int      @unique @map("user_id")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // åˆ†ç¦»çš„AIæ¨¡å‹è®¾ç½®
  programmingModel     String   @default("claude-3-5-sonnet-20241022") @db.VarChar(100) @map("programming_model")
  multipleChoiceModel  String   @default("claude-3-5-sonnet-20241022") @db.VarChar(100) @map("multiple_choice_model")
  
  // ç®€åŒ–çš„AIæ¨¡å‹è®¾ç½®ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
  aiModel          String?  @default("claude-3-5-sonnet-20241022") @db.VarChar(100) @map("ai_model")
  
  // åŸæœ‰çš„AI Model Settingsï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
  selectedProvider String   @default("claude") @db.VarChar(50) @map("selected_provider")
  extractionModel  String?  @default("claude-sonnet-4-20250514") @db.VarChar(100) @map("extraction_model")
  solutionModel    String?  @default("claude-sonnet-4-20250514") @db.VarChar(100) @map("solution_model")
  debuggingModel   String?  @default("claude-sonnet-4-20250514") @db.VarChar(100) @map("debugging_model")
  
  // Language Settings
  language         String   @default("python") @db.VarChar(50)
  
  // UI Settings
  theme            String   @default("system") @db.VarChar(20) // light, dark, system
  opacity          Float    @default(1.0)
  showCopyButton   Boolean  @default(true) @map("show_copy_button")
  
  // å¿«æ·é”®è®¾ç½®ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰
  shortcuts        String?  @db.Text
  
  // æ˜¾ç¤ºè®¾ç½®ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰
  display          String?  @db.Text
  
  // å¤„ç†è®¾ç½®ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰
  processing       String?  @db.Text
  
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("user_configs")
}

model UserSession {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique @db.VarChar(255)
  refreshToken String   @unique @db.VarChar(255) @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  isActive     Boolean  @default(true) @map("is_active")

  @@map("user_sessions")
}

model UsageRecord {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action      String   @db.VarChar(50) // "extraction", "solution", "debugging"
  model       String   @db.VarChar(100) // ä½¿ç”¨çš„å…·ä½“æ¨¡å‹
  provider    String   @db.VarChar(50) // AIæä¾›å•†
  tokensUsed  Int?     @map("tokens_used") // ä½¿ç”¨çš„tokenæ•°é‡
  success     Boolean  @default(true)
  errorMsg    String?  @db.Text @map("error_msg")
  
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("usage_records")
}

// AIæ¨¡å‹å®šä¹‰è¡¨ - ç”¨äºç®¡ç†æ”¯æŒçš„æ¨¡å‹
model AIModel {
  id          Int      @id @default(autoincrement())
  modelId     String   @unique @db.VarChar(100) @map("model_id") // claude-3-7-sonnet-20250219
  name        String   @db.VarChar(100) // Claude 3.7 Sonnet
  provider    String   @db.VarChar(50) // claude, gemini, openai
  category    String   @db.VarChar(50) // extraction, solution, debugging, general
  isActive    Boolean  @default(true) @map("is_active")
  priority    Int      @default(0) // æ’åºä¼˜å…ˆçº§
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("ai_models")
}

// é‚®ç®±éªŒè¯ç è¡¨ - ç”¨äºæ³¨å†ŒéªŒè¯
model EmailVerificationCode {
  id          Int      @id @default(autoincrement())
  email       String   @db.VarChar(100)
  code        String   @db.VarChar(10) // éªŒè¯ç 
  token       String   @unique @db.VarChar(255) // éªŒè¯ä»¤ç‰Œ
  expiresAt   DateTime @map("expires_at")
  isUsed      Boolean  @default(false) @map("is_used")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("email_verification_codes")
}

// Redisä¼šè¯å­˜å‚¨å¤‡ä»½è¡¨ï¼ˆå¯é€‰ï¼‰
model RedisSession {
  id          Int      @id @default(autoincrement())
  sessionId   String   @unique @db.VarChar(100) @map("session_id")
  userId      Int?     @map("user_id")
  data        String   @db.Text // JSONå­—ç¬¦ä¸²
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("redis_sessions")
}

// ğŸ”¥ ç§¯åˆ†ç³»ç»Ÿç›¸å…³è¡¨

// æ¨¡å‹ç§¯åˆ†é…ç½®è¡¨
model ModelPointConfig {
  id           Int      @id @default(autoincrement())
  modelName    String   @db.VarChar(100) @map("model_name") // AIæ¨¡å‹åç§°
  questionType QuestionType @map("question_type") // é¢˜ç›®ç±»å‹
  cost         Int      // ç§¯åˆ†æ¶ˆè€—
  isActive     Boolean  @default(true) @map("is_active") // æ˜¯å¦å¯ç”¨
  description  String?  @db.Text // é…ç½®æè¿°
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([modelName, questionType], name: "unique_model_question_type")
  @@map("model_point_configs")
}

// ç§¯åˆ†äº¤æ˜“è®°å½•è¡¨
model PointTransaction {
  id              Int             @id @default(autoincrement())
  userId          Int             @map("user_id")
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactionType TransactionType @map("transaction_type") // äº¤æ˜“ç±»å‹
  amount          Int             // ç§¯åˆ†æ•°é‡(æ¶ˆè´¹ä¸ºè´Ÿæ•°ï¼Œå……å€¼ä¸ºæ­£æ•°)
  balanceAfter    Int             @map("balance_after") // æ“ä½œåä½™é¢
  modelName       String?         @db.VarChar(100) @map("model_name") // ç›¸å…³æ¨¡å‹åç§°
  questionType    QuestionType?   @map("question_type") // é¢˜ç›®ç±»å‹
  description     String?         @db.Text // äº¤æ˜“æè¿°
  metadata        String?         @db.Text // é¢å¤–å…ƒæ•°æ®(JSONæ ¼å¼)
  createdAt       DateTime        @default(now()) @map("created_at")

  @@map("point_transactions")
}

// é¢˜ç›®ç±»å‹æšä¸¾
enum QuestionType {
  MULTIPLE_CHOICE @map("multiple_choice") // é€‰æ‹©é¢˜
  PROGRAMMING     @map("programming")     // ç¼–ç¨‹é¢˜

  @@map("question_types")
}

// äº¤æ˜“ç±»å‹æšä¸¾
enum TransactionType {
  CONSUME  @map("consume")  // æ¶ˆè´¹
  RECHARGE @map("recharge") // å……å€¼
  REFUND   @map("refund")   // é€€æ¬¾
  REWARD   @map("reward")   // å¥–åŠ±

  @@map("transaction_types")
} 