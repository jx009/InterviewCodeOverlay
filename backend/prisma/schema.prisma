// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique @db.VarChar(50)
  email     String?  @unique @db.VarChar(100)
  password  String   @db.VarChar(255)
  role      UserRole @default(USER) // ç”¨æˆ·è§’è‰²ï¼Œé»˜è®¤ä¸ºæ™®é€šç”¨æˆ·
  isActive  Boolean  @default(true)
  points    Int      @default(100) // ç”¨æˆ·ç§¯åˆ†ä½™é¢ï¼Œæ–°ç”¨æˆ·é»˜è®¤100ç§¯åˆ†
  
  // é‚€è¯·ç³»ç»Ÿå­—æ®µ
  inviteCode String?  @unique @db.VarChar(20) @map("invite_code") // é‚€è¯·ç 
  inviterId  Int?     @map("inviter_id") // é‚€è¯·äººID
  invitedAt  DateTime? @map("invited_at") // è¢«é‚€è¯·æ—¶é—´
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  config       UserConfig?
  usage        UsageRecord[]
  sessions     UserSession[]
  transactions PointTransaction[] // ç§¯åˆ†äº¤æ˜“è®°å½•
  paymentOrders PaymentOrder[]    // æ”¯ä»˜è®¢å•è®°å½•
  
  // é‚€è¯·ç³»ç»Ÿå…³ç³»
  inviteRecords InviteRecord[] @relation("InviterRecords") // ä½œä¸ºé‚€è¯·äººçš„è®°å½•
  invitedRecords InviteRecord[] @relation("InviteeRecords") // ä½œä¸ºè¢«é‚€è¯·äººçš„è®°å½•
  inviteRewards InviteReward[] @relation("InviterRewards") // ä½œä¸ºé‚€è¯·äººçš„å¥–åŠ±
  invitedRewards InviteReward[] @relation("InviteeRewards") // ä½œä¸ºè¢«é‚€è¯·äººçš„å¥–åŠ±

  @@map("users")
}

model UserConfig {
  id               Int      @id @default(autoincrement())
  userId           Int      @unique @map("user_id")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // åˆ†ç¦»çš„AIæ¨¡å‹è®¾ç½®
  programmingModel     String   @default("claude-3-5-sonnet-20241022") @db.VarChar(100) @map("programming_model")
  multipleChoiceModel  String   @default("claude-3-5-sonnet-20241022") @db.VarChar(100) @map("multiple_choice_model")
  
  // ç®€åŒ–çš„AIæ¨¡å‹è®¾ç½®ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
  aiModel          String?  @default("claude-3-5-sonnet-20241022") @db.VarChar(100) @map("ai_model")
  
  // åŸæœ‰çš„AI Model Settingsï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
  selectedProvider String   @default("claude") @db.VarChar(50) @map("selected_provider")
  extractionModel  String?  @default("claude-sonnet-4-20250514") @db.VarChar(100) @map("extraction_model")
  solutionModel    String?  @default("claude-sonnet-4-20250514") @db.VarChar(100) @map("solution_model")
  debuggingModel   String?  @default("claude-sonnet-4-20250514") @db.VarChar(100) @map("debugging_model")
  
  // Language Settings
  language         String   @default("python") @db.VarChar(50)
  
  // UI Settings
  theme            String   @default("system") @db.VarChar(20) // light, dark, system
  opacity          Float    @default(1.0)
  showCopyButton   Boolean  @default(true) @map("show_copy_button")
  
  // å¿«æ·é”®è®¾ç½®ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰
  shortcuts        String?  @db.Text
  
  // æ˜¾ç¤ºè®¾ç½®ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰
  display          String?  @db.Text
  
  // å¤„ç†è®¾ç½®ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰
  processing       String?  @db.Text
  
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("user_configs")
}

model UserSession {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique @db.VarChar(255)
  refreshToken String   @unique @db.VarChar(255) @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  isActive     Boolean  @default(true) @map("is_active")

  @@map("user_sessions")
}

model UsageRecord {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action      String   @db.VarChar(50) // "extraction", "solution", "debugging"
  model       String   @db.VarChar(100) // ä½¿ç”¨çš„å…·ä½“æ¨¡å‹
  provider    String   @db.VarChar(50) // AIæä¾›å•†
  tokensUsed  Int?     @map("tokens_used") // ä½¿ç”¨çš„tokenæ•°é‡
  success     Boolean  @default(true)
  errorMsg    String?  @db.Text @map("error_msg")
  
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("usage_records")
}

// AIæ¨¡å‹å®šä¹‰è¡¨ - ç”¨äºç®¡ç†æ”¯æŒçš„æ¨¡å‹
model AIModel {
  id          Int      @id @default(autoincrement())
  modelId     String   @unique @db.VarChar(100) @map("model_id") // claude-3-7-sonnet-20250219
  name        String   @db.VarChar(100) // Claude 3.7 Sonnet
  provider    String   @db.VarChar(50) // claude, gemini, openai
  category    String   @db.VarChar(50) // extraction, solution, debugging, general
  isActive    Boolean  @default(true) @map("is_active")
  priority    Int      @default(0) // æ’åºä¼˜å…ˆçº§
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("ai_models")
}

// é‚®ç®±éªŒè¯ç è¡¨ - ç”¨äºæ³¨å†ŒéªŒè¯
model EmailVerificationCode {
  id          Int      @id @default(autoincrement())
  email       String   @db.VarChar(100)
  code        String   @db.VarChar(10) // éªŒè¯ç 
  token       String   @unique @db.VarChar(255) // éªŒè¯ä»¤ç‰Œ
  expiresAt   DateTime @map("expires_at")
  isUsed      Boolean  @default(false) @map("is_used")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("email_verification_codes")
}

// Redisä¼šè¯å­˜å‚¨å¤‡ä»½è¡¨ï¼ˆå¯é€‰ï¼‰
model RedisSession {
  id          Int      @id @default(autoincrement())
  sessionId   String   @unique @db.VarChar(100) @map("session_id")
  userId      Int?     @map("user_id")
  data        String   @db.Text // JSONå­—ç¬¦ä¸²
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("redis_sessions")
}

// ğŸ”¥ ç§¯åˆ†ç³»ç»Ÿç›¸å…³è¡¨

// æ¨¡å‹ç§¯åˆ†é…ç½®è¡¨
model ModelPointConfig {
  id           Int      @id @default(autoincrement())
  modelName    String   @db.VarChar(100) @map("model_name") // AIæ¨¡å‹åç§°
  questionType QuestionType @map("question_type") // é¢˜ç›®ç±»å‹
  cost         Int      // ç§¯åˆ†æ¶ˆè€—
  isActive     Boolean  @default(true) @map("is_active") // æ˜¯å¦å¯ç”¨
  description  String?  @db.Text // é…ç½®æè¿°
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([modelName, questionType], name: "unique_model_question_type")
  @@map("model_point_configs")
}

// ç§¯åˆ†äº¤æ˜“è®°å½•è¡¨
model PointTransaction {
  id              Int             @id @default(autoincrement())
  userId          Int             @map("user_id")
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactionType TransactionType @map("transaction_type") // äº¤æ˜“ç±»å‹
  amount          Int             // ç§¯åˆ†æ•°é‡(æ¶ˆè´¹ä¸ºè´Ÿæ•°ï¼Œå……å€¼ä¸ºæ­£æ•°)
  balanceAfter    Int             @map("balance_after") // æ“ä½œåä½™é¢
  modelName       String?         @db.VarChar(100) @map("model_name") // ç›¸å…³æ¨¡å‹åç§°
  questionType    QuestionType?   @map("question_type") // é¢˜ç›®ç±»å‹
  description     String?         @db.Text // äº¤æ˜“æè¿°
  metadata        String?         @db.Text // é¢å¤–å…ƒæ•°æ®(JSONæ ¼å¼)
  createdAt       DateTime        @default(now()) @map("created_at")

  @@map("point_transactions")
}

// é¢˜ç›®ç±»å‹æšä¸¾
enum QuestionType {
  MULTIPLE_CHOICE @map("multiple_choice") // é€‰æ‹©é¢˜
  PROGRAMMING     @map("programming")     // ç¼–ç¨‹é¢˜

  @@map("question_types")
}

// äº¤æ˜“ç±»å‹æšä¸¾
enum TransactionType {
  CONSUME  @map("consume")  // æ¶ˆè´¹
  RECHARGE @map("recharge") // å……å€¼
  REFUND   @map("refund")   // é€€æ¬¾
  REWARD   @map("reward")   // å¥–åŠ±

  @@map("transaction_types")
}

// ğŸ’° æ”¯ä»˜ç³»ç»Ÿç›¸å…³è¡¨

// æ”¯ä»˜è®¢å•è¡¨
model PaymentOrder {
  id            Int           @id @default(autoincrement())
  orderNo       String        @unique @db.VarChar(64) @map("order_no") // ç³»ç»Ÿè®¢å•å·
  outTradeNo    String        @unique @db.VarChar(64) @map("out_trade_no") // å•†æˆ·è®¢å•å·
  userId        Int           @map("user_id")
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount        Decimal       @db.Decimal(10,2) // æ”¯ä»˜é‡‘é¢(å…ƒ)
  points        Int           // å……å€¼ç§¯åˆ†æ•°é‡
  bonusPoints   Int           @default(0) @map("bonus_points") // èµ é€ç§¯åˆ†
  paymentMethod PaymentMethod @map("payment_method") // æ”¯ä»˜æ–¹å¼
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status") // æ”¯ä»˜çŠ¶æ€
  transactionId String?       @db.VarChar(64) @map("transaction_id") // ç¬¬ä¸‰æ–¹äº¤æ˜“ID
  paymentTime   DateTime?     @map("payment_time") // æ”¯ä»˜å®Œæˆæ—¶é—´
  notifyTime    DateTime?     @map("notify_time") // å›è°ƒé€šçŸ¥æ—¶é—´
  expireTime    DateTime      @map("expire_time") // è®¢å•è¿‡æœŸæ—¶é—´
  packageId     Int?          @map("package_id") // å…³è”çš„å¥—é¤ID
  package       PaymentPackage? @relation(fields: [packageId], references: [id])
  metadata      String?       @db.Text // è®¢å•å…ƒæ•°æ®(JSONæ ¼å¼)
  failReason    String?       @db.Text @map("fail_reason") // å¤±è´¥åŸå› 
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@index([userId])
  @@index([orderNo])
  @@index([paymentStatus])
  @@index([createdAt])
  @@map("payment_orders")
}

// æ”¯ä»˜å……å€¼å¥—é¤è¡¨
model PaymentPackage {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100) // å¥—é¤åç§°
  description String?  @db.Text // å¥—é¤æè¿°
  amount      Decimal  @db.Decimal(10,2) // ä»·æ ¼(å…ƒ)
  points      Int      // è·å¾—ç§¯åˆ†
  bonusPoints Int      @default(0) @map("bonus_points") // èµ é€ç§¯åˆ†
  isActive    Boolean  @default(true) @map("is_active") // æ˜¯å¦å¯ç”¨
  sortOrder   Int      @default(0) @map("sort_order") // æ’åºæƒé‡
  icon        String?  @db.VarChar(255) // å¥—é¤å›¾æ ‡
  tags        String?  @db.Text // æ ‡ç­¾(JSONæ ¼å¼: ["æ¨è", "é™æ—¶"])
  isRecommended Boolean @default(false) @map("is_recommended") // æ˜¯å¦æ¨è
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  orders      PaymentOrder[]

  @@index([isActive])
  @@index([sortOrder])
  @@map("payment_packages")
}

// æ”¯ä»˜å›è°ƒæ—¥å¿—è¡¨
model PaymentNotifyLog {
  id            Int           @id @default(autoincrement())
  orderNo       String        @db.VarChar(64) @map("order_no") // è®¢å•å·
  paymentMethod PaymentMethod @map("payment_method") // æ”¯ä»˜æ–¹å¼
  notifyType    String        @db.VarChar(50) @map("notify_type") // é€šçŸ¥ç±»å‹
  requestBody   String        @db.Text @map("request_body") // å›è°ƒè¯·æ±‚ä½“
  requestHeaders String?      @db.Text @map("request_headers") // è¯·æ±‚å¤´(JSONæ ¼å¼)
  responseStatus Int          @default(200) @map("response_status") // å“åº”çŠ¶æ€ç 
  processStatus NotifyStatus  @default(PENDING) @map("process_status") // å¤„ç†çŠ¶æ€
  errorMessage  String?       @db.Text @map("error_message") // é”™è¯¯ä¿¡æ¯
  processTime   DateTime?     @map("process_time") // å¤„ç†æ—¶é—´
  retryCount    Int           @default(0) @map("retry_count") // é‡è¯•æ¬¡æ•°
  createdAt     DateTime      @default(now()) @map("created_at")

  @@index([orderNo])
  @@index([processStatus])
  @@index([createdAt])
  @@map("payment_notify_logs")
}

// æ”¯ä»˜æ–¹å¼æšä¸¾
enum PaymentMethod {
  WECHAT_PAY @map("wechat_pay") // å¾®ä¿¡æ”¯ä»˜
  ALIPAY     @map("alipay")     // æ”¯ä»˜å®
  
  @@map("payment_methods")
}

// æ”¯ä»˜çŠ¶æ€æšä¸¾
enum PaymentStatus {
  PENDING   @map("pending")   // å¾…æ”¯ä»˜
  PAID      @map("paid")      // å·²æ”¯ä»˜
  FAILED    @map("failed")    // æ”¯ä»˜å¤±è´¥
  CANCELLED @map("cancelled") // å·²å–æ¶ˆ
  REFUNDED  @map("refunded")  // å·²é€€æ¬¾
  EXPIRED   @map("expired")   // å·²è¿‡æœŸ
  
  @@map("payment_statuses")
}

// é€šçŸ¥å¤„ç†çŠ¶æ€æšä¸¾
enum NotifyStatus {
  PENDING @map("pending") // å¾…å¤„ç†
  SUCCESS @map("success") // å¤„ç†æˆåŠŸ
  FAILED  @map("failed")  // å¤„ç†å¤±è´¥
  
  @@map("notify_statuses")
}

// ç”¨æˆ·è§’è‰²æšä¸¾
enum UserRole {
  USER  @map("user")  // æ™®é€šç”¨æˆ·
  ADMIN @map("admin") // ç®¡ç†å‘˜
  
  @@map("user_roles")
}

// ğŸ¯ é‚€è¯·ç³»ç»Ÿç›¸å…³è¡¨

// é‚€è¯·è®°å½•è¡¨
model InviteRecord {
  id                  Int      @id @default(autoincrement())
  inviterId           Int      @map("inviter_id") // é‚€è¯·äººID
  inviteeId           Int      @map("invitee_id") // è¢«é‚€è¯·äººID
  inviteCode          String   @db.VarChar(20) @map("invite_code") // é‚€è¯·ç 
  status              String   @default("REGISTERED") @db.VarChar(20) // çŠ¶æ€ï¼šREGISTERED, ACTIVATED
  firstRechargeAmount Decimal  @default(0) @db.Decimal(10,2) @map("first_recharge_amount") // é¦–æ¬¡å……å€¼é‡‘é¢
  commissionAmount    Decimal  @default(0) @db.Decimal(10,2) @map("commission_amount") // ä½£é‡‘é‡‘é¢
  commissionStatus    String   @default("PENDING") @db.VarChar(20) @map("commission_status") // ä½£é‡‘çŠ¶æ€
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  inviter User @relation("InviterRecords", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee User @relation("InviteeRecords", fields: [inviteeId], references: [id], onDelete: Cascade)

  @@unique([inviteeId]) // æ¯ä¸ªç”¨æˆ·åªèƒ½è¢«é‚€è¯·ä¸€æ¬¡
  @@index([inviterId])
  @@index([status])
  @@map("invite_records")
}

// é‚€è¯·å¥–åŠ±è®°å½•è¡¨
model InviteReward {
  id           Int      @id @default(autoincrement())
  inviterId    Int      @map("inviter_id") // é‚€è¯·äººID
  inviteeId    Int      @map("invitee_id") // è¢«é‚€è¯·äººID
  rewardType   String   @db.VarChar(20) @map("reward_type") // å¥–åŠ±ç±»å‹ï¼šREGISTER, FIRST_RECHARGE, COMMISSION
  rewardAmount Int      @map("reward_amount") // å¥–åŠ±ç§¯åˆ†æ•°é‡
  description  String?  @db.Text // å¥–åŠ±æè¿°
  status       String   @default("GRANTED") @db.VarChar(20) // çŠ¶æ€ï¼šPENDING, GRANTED, FAILED
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  inviter User @relation("InviterRewards", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee User @relation("InviteeRewards", fields: [inviteeId], references: [id], onDelete: Cascade)

  @@index([inviterId])
  @@index([rewardType])
  @@index([status])
  @@map("invite_rewards")
} 