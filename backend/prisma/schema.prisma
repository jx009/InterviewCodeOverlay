// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique @db.VarChar(50)
  email     String?  @unique @db.VarChar(100)
  password  String   @db.VarChar(255)
  isActive  Boolean  @default(true)
  points    Int      @default(100) // 用户积分余额，新用户默认100积分
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  config       UserConfig?
  usage        UsageRecord[]
  sessions     UserSession[]
  transactions PointTransaction[] // 积分交易记录

  @@map("users")
}

model UserConfig {
  id               Int      @id @default(autoincrement())
  userId           Int      @unique @map("user_id")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 分离的AI模型设置
  programmingModel     String   @default("claude-3-5-sonnet-20241022") @db.VarChar(100) @map("programming_model")
  multipleChoiceModel  String   @default("claude-3-5-sonnet-20241022") @db.VarChar(100) @map("multiple_choice_model")
  
  // 简化的AI模型设置（保持向后兼容）
  aiModel          String?  @default("claude-3-5-sonnet-20241022") @db.VarChar(100) @map("ai_model")
  
  // 原有的AI Model Settings（保持兼容性）
  selectedProvider String   @default("claude") @db.VarChar(50) @map("selected_provider")
  extractionModel  String?  @default("claude-sonnet-4-20250514") @db.VarChar(100) @map("extraction_model")
  solutionModel    String?  @default("claude-sonnet-4-20250514") @db.VarChar(100) @map("solution_model")
  debuggingModel   String?  @default("claude-sonnet-4-20250514") @db.VarChar(100) @map("debugging_model")
  
  // Language Settings
  language         String   @default("python") @db.VarChar(50)
  
  // UI Settings
  theme            String   @default("system") @db.VarChar(20) // light, dark, system
  opacity          Float    @default(1.0)
  showCopyButton   Boolean  @default(true) @map("show_copy_button")
  
  // 快捷键设置（JSON字符串）
  shortcuts        String?  @db.Text
  
  // 显示设置（JSON字符串）
  display          String?  @db.Text
  
  // 处理设置（JSON字符串）
  processing       String?  @db.Text
  
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("user_configs")
}

model UserSession {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique @db.VarChar(255)
  refreshToken String   @unique @db.VarChar(255) @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  isActive     Boolean  @default(true) @map("is_active")

  @@map("user_sessions")
}

model UsageRecord {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action      String   @db.VarChar(50) // "extraction", "solution", "debugging"
  model       String   @db.VarChar(100) // 使用的具体模型
  provider    String   @db.VarChar(50) // AI提供商
  tokensUsed  Int?     @map("tokens_used") // 使用的token数量
  success     Boolean  @default(true)
  errorMsg    String?  @db.Text @map("error_msg")
  
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("usage_records")
}

// AI模型定义表 - 用于管理支持的模型
model AIModel {
  id          Int      @id @default(autoincrement())
  modelId     String   @unique @db.VarChar(100) @map("model_id") // claude-3-7-sonnet-20250219
  name        String   @db.VarChar(100) // Claude 3.7 Sonnet
  provider    String   @db.VarChar(50) // claude, gemini, openai
  category    String   @db.VarChar(50) // extraction, solution, debugging, general
  isActive    Boolean  @default(true) @map("is_active")
  priority    Int      @default(0) // 排序优先级
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("ai_models")
}

// 邮箱验证码表 - 用于注册验证
model EmailVerificationCode {
  id          Int      @id @default(autoincrement())
  email       String   @db.VarChar(100)
  code        String   @db.VarChar(10) // 验证码
  token       String   @unique @db.VarChar(255) // 验证令牌
  expiresAt   DateTime @map("expires_at")
  isUsed      Boolean  @default(false) @map("is_used")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("email_verification_codes")
}

// Redis会话存储备份表（可选）
model RedisSession {
  id          Int      @id @default(autoincrement())
  sessionId   String   @unique @db.VarChar(100) @map("session_id")
  userId      Int?     @map("user_id")
  data        String   @db.Text // JSON字符串
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("redis_sessions")
}

// 🔥 积分系统相关表

// 模型积分配置表
model ModelPointConfig {
  id           Int      @id @default(autoincrement())
  modelName    String   @db.VarChar(100) @map("model_name") // AI模型名称
  questionType QuestionType @map("question_type") // 题目类型
  cost         Int      // 积分消耗
  isActive     Boolean  @default(true) @map("is_active") // 是否启用
  description  String?  @db.Text // 配置描述
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([modelName, questionType], name: "unique_model_question_type")
  @@map("model_point_configs")
}

// 积分交易记录表
model PointTransaction {
  id              Int             @id @default(autoincrement())
  userId          Int             @map("user_id")
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactionType TransactionType @map("transaction_type") // 交易类型
  amount          Int             // 积分数量(消费为负数，充值为正数)
  balanceAfter    Int             @map("balance_after") // 操作后余额
  modelName       String?         @db.VarChar(100) @map("model_name") // 相关模型名称
  questionType    QuestionType?   @map("question_type") // 题目类型
  description     String?         @db.Text // 交易描述
  metadata        String?         @db.Text // 额外元数据(JSON格式)
  createdAt       DateTime        @default(now()) @map("created_at")

  @@map("point_transactions")
}

// 题目类型枚举
enum QuestionType {
  MULTIPLE_CHOICE @map("multiple_choice") // 选择题
  PROGRAMMING     @map("programming")     // 编程题

  @@map("question_types")
}

// 交易类型枚举
enum TransactionType {
  CONSUME  @map("consume")  // 消费
  RECHARGE @map("recharge") // 充值
  REFUND   @map("refund")   // 退款
  REWARD   @map("reward")   // 奖励

  @@map("transaction_types")
} 