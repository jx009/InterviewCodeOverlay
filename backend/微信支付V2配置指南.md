# 微信支付V2配置指南

## 📋 概述

本指南将帮助您配置微信支付V2功能，解决支付认证和配置问题。

## 🔧 环境变量配置

### 1. 创建.env文件

在 `InterviewCodeOverlay/backend/` 目录下创建 `.env` 文件：

```bash
# 复制配置模板
cp env.example .env
cp env.payment.example .env.payment

# 合并两个配置文件内容到 .env
```

### 2. 必要的微信支付配置

在 `.env` 文件中添加以下配置：

```env
# ===============================================
# 🔒 微信支付V2配置 - 核心配置
# ===============================================

# 微信支付基础配置
WECHAT_PAY_V2_APP_ID=wx1234567890abcdef
WECHAT_PAY_V2_MCH_ID=1234567890
WECHAT_PAY_V2_API_KEY=your32characterapikeyhere1234567890
WECHAT_PAY_V2_SIGN_TYPE=MD5

# 微信支付回调URL
WECHAT_PAY_V2_NOTIFY_URL=https://yourdomain.com/api/payment/notify/wechat
BASE_URL=https://yourdomain.com

# 微信支付证书路径（退款功能需要）
WECHAT_PAY_V2_CERT_PATH=./certs/apiclient_cert.pem
WECHAT_PAY_V2_KEY_PATH=./certs/apiclient_key.pem

# 支付环境设置
PAYMENT_SANDBOX_MODE=true
NODE_ENV=development
```

### 3. 其他必要配置

```env
# 数据库配置
DATABASE_URL="mysql://username:password@localhost:3306/interview_coder"

# Redis配置
REDIS_URL="redis://localhost:6379"
REDIS_PASSWORD=""
REDIS_DB=0

# JWT密钥配置
JWT_SECRET="your_jwt_secret_key_here"
JWT_REFRESH_SECRET="your_jwt_refresh_secret_key_here"

# 服务器配置
PORT=3001
CORS_ORIGIN="http://localhost:3000,http://localhost:54321"
```

## 🏗️ 获取微信支付配置

### 1. 注册微信商户号

1. 访问 [微信支付商户平台](https://pay.weixin.qq.com/)
2. 注册商户号并完成认证
3. 获取商户号（MCH_ID）

### 2. 创建微信小程序/公众号

1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 创建小程序或公众号
3. 获取 AppID

### 3. 配置API密钥

1. 登录微信商户平台
2. 进入 "账户中心" → "API安全"
3. 设置API密钥（32位字符串）
4. 保存密钥到 `WECHAT_PAY_V2_API_KEY`

### 4. 配置支付回调URL

1. 在微信商户平台设置支付回调URL
2. URL格式：`https://yourdomain.com/api/payment/notify/wechat`
3. 确保URL可以公网访问

## 🔒 安全配置

### 1. 生产环境配置

```env
# 生产环境设置
NODE_ENV=production
PAYMENT_SANDBOX_MODE=false
WECHAT_PAY_V2_NOTIFY_URL=https://yourdomain.com/api/payment/notify/wechat
BASE_URL=https://yourdomain.com
```

### 2. 开发环境配置

```env
# 开发环境设置
NODE_ENV=development
PAYMENT_SANDBOX_MODE=true
WECHAT_PAY_V2_NOTIFY_URL=https://yourdomain.com/api/payment/notify/wechat
BASE_URL=http://localhost:3001
```

## 🛠️ 修复说明

本次修复包含以下内容：

### 1. 认证中间件统一化

- 修复了支付模块认证中间件的问题
- 统一了JWT和sessionId的认证逻辑
- 确保所有支付API都使用相同的认证机制

### 2. 微信支付V2配置优化

- 支持多种环境变量名称
- 增强了配置验证逻辑
- 提供了详细的错误提示和配置指导

### 3. 支付路由更新

- 修复了订单列表API的认证问题
- 优化了错误处理和日志记录
- 确保微信支付回调正确处理

### 4. 会话验证增强

- 增强了会话验证的稳定性
- 添加了会话过期检查
- 改善了错误处理和日志记录

## 🚀 启动服务

1. 确保所有环境变量已正确配置
2. 启动Redis服务
3. 启动MySQL数据库
4. 运行后端服务：

```bash
cd InterviewCodeOverlay/backend
npm install
npm run dev
```

## 🧪 测试支付功能

### 1. 测试套餐列表

```bash
curl -X GET http://localhost:3001/api/payment/packages
```

### 2. 测试创建订单（需要登录）

```bash
curl -X POST http://localhost:3001/api/payment/orders \
  -H "Content-Type: application/json" \
  -H "X-Session-Id: your-session-id" \
  -d '{"packageId": 1, "paymentMethod": "WECHAT_PAY"}'
```

### 3. 测试订单列表（需要登录）

```bash
curl -X GET http://localhost:3001/api/payment/orders \
  -H "X-Session-Id: your-session-id"
```

## 🔍 问题排查

### 1. 401未授权错误

- 检查 `X-Session-Id` 或 `Authorization` 头部是否正确
- 确认用户已登录且会话有效
- 检查JWT密钥配置是否正确

### 2. 微信支付配置错误

- 验证AppID格式（wx开头的18位字符）
- 验证商户号格式（8-10位数字）
- 验证API密钥长度（32位字符）
- 检查回调URL是否可访问

### 3. 数据库连接问题

- 检查DATABASE_URL配置
- 确认MySQL服务正在运行
- 验证数据库用户权限

### 4. Redis连接问题

- 检查REDIS_URL配置
- 确认Redis服务正在运行
- 验证Redis密码设置

## 📚 参考文档

- [微信支付官方文档V2](https://pay.weixin.qq.com/doc/v2/merchant/4011935206)
- [微信支付APIv2开发指南](https://blog.csdn.net/qq_56947957/article/details/145003611)
- [微信支付商户平台](https://pay.weixin.qq.com/)

## 💡 注意事项

1. **生产环境**：
   - 必须使用HTTPS
   - 不要使用默认的API密钥
   - 定期更新API密钥

2. **开发环境**：
   - 可以使用HTTP进行本地测试
   - 建议使用沙箱环境

3. **安全性**：
   - 不要将.env文件提交到版本控制
   - 定期检查API密钥的安全性
   - 监控异常支付请求

4. **测试**：
   - 使用微信支付提供的测试工具
   - 验证支付回调是否正确处理
   - 测试各种支付场景和错误情况 