# 数据库配置文件使用说明

## 概述
本项目现在使用统一的JSON配置文件来管理MySQL、Redis、邮件服务等所有配置，不再依赖环境变量。

## 配置文件位置
配置文件会按以下顺序查找：
1. `config/database-config.json` (推荐)
2. `backend/config/database-config.json`
3. `database-config.json` (项目根目录)

## 快速开始

### 1. 复制配置模板
```bash
cd backend
cp config/database-config.example.json config/database-config.json
```

### 2. 编辑配置文件
打开 `config/database-config.json` 文件，修改以下关键配置：

```json
{
  "mysql": {
    "host": "localhost",
    "port": 3306,
    "username": "your_mysql_username",
    "password": "your_mysql_password", 
    "database": "interview_coder"
  },
  "redis": {
    "host": "localhost",
    "port": 6379,
    "password": "your_redis_password"
  },
  "email": {
    "smtp": {
      "host": "smtp.gmail.com",
      "port": 587,
      "auth": {
        "user": "your-email@gmail.com",
        "pass": "your-app-password"
      }
    },
    "from": "your-email@gmail.com"
  },
  "security": {
    "jwtSecret": "your-super-secret-jwt-key",
    "jwtRefreshSecret": "your-super-secret-refresh-key"
  }
}
```

## 详细配置说明

### MySQL配置
```json
{
  "mysql": {
    "host": "localhost",              // MySQL服务器地址
    "port": 3306,                     // MySQL端口
    "username": "interview_user",     // 数据库用户名
    "password": "your_secure_password",// 数据库密码
    "database": "interview_coder",    // 数据库名称
    "charset": "utf8mb4",             // 字符集
    "collation": "utf8mb4_unicode_ci",// 排序规则
    "timezone": "+08:00",             // 时区
    "connectionLimit": 10,            // 连接池大小
    "acquireTimeout": 60000,          // 获取连接超时时间(ms)
    "timeout": 60000,                 // 查询超时时间(ms)
    "reconnect": true,                // 自动重连
    "ssl": false                      // 是否使用SSL
  }
}
```

### Redis配置
```json
{
  "redis": {
    "host": "localhost",              // Redis服务器地址
    "port": 6379,                     // Redis端口
    "password": "",                   // Redis密码(空字符串表示无密码)
    "database": 0,                    // Redis数据库编号
    "keyPrefix": "interview_coder:",  // 键前缀
    "retryDelayOnFailover": 100,      // 重试延迟(ms)
    "maxRetriesPerRequest": 3,        // 最大重试次数
    "lazyConnect": true,              // 延迟连接
    "keepAlive": 30000                // 保持连接时间(ms)
  }
}
```

### 会话配置
```json
{
  "session": {
    "secret": "your-super-secret-session-key", // 会话密钥
    "expiresIn": 3600,                         // 会话过期时间(秒)
    "refreshExpiresIn": 604800,                // 刷新令牌过期时间(秒)
    "cookieName": "interview_session",         // Cookie名称
    "secure": false,                           // 是否只在HTTPS下使用
    "httpOnly": true,                          // 是否禁止JavaScript访问
    "sameSite": "lax"                          // 跨站请求策略
  }
}
```

### 邮件配置
```json
{
  "email": {
    "smtp": {
      "host": "smtp.gmail.com",       // SMTP服务器
      "port": 587,                    // SMTP端口
      "secure": false,                // 是否使用SSL/TLS
      "auth": {
        "user": "your-email@gmail.com",  // 邮箱用户名
        "pass": "your-app-password"      // 邮箱密码/应用密码
      }
    },
    "from": "your-email@gmail.com",   // 发件人地址
    "verification": {
      "codeLength": 6,                // 验证码长度
      "expiresMinutes": 5,            // 验证码过期时间(分钟)
      "template": "default"           // 邮件模板
    }
  }
}
```

### 安全配置
```json
{
  "security": {
    "bcryptRounds": 12,                      // 密码加密轮数
    "jwtSecret": "your-super-secret-jwt-key", // JWT密钥
    "jwtRefreshSecret": "your-super-secret-refresh-key", // JWT刷新密钥
    "passwordMinLength": 6,                  // 密码最小长度
    "maxLoginAttempts": 5,                   // 最大登录尝试次数
    "lockoutDuration": 900                   // 锁定时间(秒)
  }
}
```

### 应用配置
```json
{
  "app": {
    "name": "面试代码助手",          // 应用名称
    "version": "1.0.0",           // 应用版本
    "environment": "development", // 运行环境
    "debug": true,                // 是否开启调试模式
    "logLevel": "info"            // 日志级别
  }
}
```

## 常用邮件服务配置

### Gmail
```json
{
  "email": {
    "smtp": {
      "host": "smtp.gmail.com",
      "port": 587,
      "secure": false,
      "auth": {
        "user": "your-email@gmail.com",
        "pass": "your-app-password"
      }
    }
  }
}
```

### QQ邮箱
```json
{
  "email": {
    "smtp": {
      "host": "smtp.qq.com",
      "port": 587,
      "secure": false,
      "auth": {
        "user": "your-email@qq.com",
        "pass": "your-authorization-code"
      }
    }
  }
}
```

### 163邮箱
```json
{
  "email": {
    "smtp": {
      "host": "smtp.163.com",
      "port": 465,
      "secure": true,
      "auth": {
        "user": "your-email@163.com",
        "pass": "your-authorization-code"
      }
    }
  }
}
```

## 环境变量覆盖
配置文件支持环境变量覆盖，优先级：**环境变量 > 配置文件**

支持的环境变量：
- `DATABASE_URL` - MySQL连接字符串
- `REDIS_URL` - Redis连接字符串
- `JWT_SECRET` - JWT密钥
- `JWT_REFRESH_SECRET` - JWT刷新密钥
- `SMTP_HOST` - SMTP服务器
- `SMTP_PORT` - SMTP端口
- `SMTP_USER` - 邮箱用户名
- `SMTP_PASS` - 邮箱密码
- `EMAIL_FROM` - 发件人地址
- `NODE_ENV` - 运行环境

## 配置验证
系统会自动验证配置的有效性：
- 检查必需字段是否存在
- 验证端口号范围
- 验证数据库连接
- 验证邮件服务配置

## 安全建议
1. **不要将配置文件提交到版本控制系统**
2. **使用强密码和密钥**
3. **定期更换密钥**
4. **在生产环境中设置 `secure: true`**
5. **使用环境变量存储敏感信息**

## 配置工具命令
```bash
# 检查配置是否有效
npm run db:check

# 重新加载配置
# (在代码中调用 reloadConfig())

# 查看当前配置状态
# (在代码中调用 getConfig())
```

## 故障排除

### 1. 配置文件未找到
```
Error: 未找到数据库配置文件，请创建 config/database-config.json
```
**解决方案**: 复制 `database-config.example.json` 到 `database-config.json`

### 2. 配置验证失败
```
Error: 缺少必要的配置项: mysql.password
```
**解决方案**: 检查配置文件中是否填写了所有必需的字段

### 3. 数据库连接失败
```
Error: MySQL数据库连接失败
```
**解决方案**: 检查MySQL服务是否运行，用户名密码是否正确

### 4. 邮件服务配置错误
```
Error: 邮件服务配置验证失败
```
**解决方案**: 检查SMTP配置，确保使用正确的应用密码

## 配置示例
完整的生产环境配置示例请参考 `database-config.example.json` 文件。 