name: ğŸ§¹ Cleanup Artifacts

on:
  schedule:
    # æ¯å¤©è¿è¡Œä¸€æ¬¡ï¼Œæ¸…ç†æ—§çš„artifacts
    - cron: '0 2 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  cleanup:
    name: ğŸ—‘ï¸ Delete Old Artifacts
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ§¹ Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // è·å–æ‰€æœ‰artifacts
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner,
              repo,
              per_page: 100
            });
            
            console.log(`Found ${artifacts.data.artifacts.length} artifacts`);
            
            // åˆ é™¤è¶…è¿‡1å¤©çš„artifacts
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            
            let deletedCount = 0;
            for (const artifact of artifacts.data.artifacts) {
              const createdAt = new Date(artifact.created_at);
              if (createdAt < oneDayAgo) {
                try {
                  await github.rest.actions.deleteArtifact({
                    owner,
                    repo,
                    artifact_id: artifact.id
                  });
                  console.log(`Deleted artifact: ${artifact.name} (${artifact.id})`);
                  deletedCount++;
                } catch (error) {
                  console.log(`Failed to delete artifact ${artifact.name}: ${error.message}`);
                }
              }
            }
            
            console.log(`Deleted ${deletedCount} old artifacts`);
            
            // å¦‚æœè¿˜æœ‰å¤ªå¤šartifactsï¼Œåˆ é™¤æœ€æ—§çš„ä¸€äº›
            if (artifacts.data.artifacts.length > 10) {
              const sortedArtifacts = artifacts.data.artifacts
                .sort((a, b) => new Date(a.created_at) - new Date(b.created_at))
                .slice(0, artifacts.data.artifacts.length - 5); // ä¿ç•™æœ€æ–°çš„5ä¸ª
              
              for (const artifact of sortedArtifacts) {
                try {
                  await github.rest.actions.deleteArtifact({
                    owner,
                    repo,
                    artifact_id: artifact.id
                  });
                  console.log(`Deleted excess artifact: ${artifact.name} (${artifact.id})`);
                  deletedCount++;
                } catch (error) {
                  console.log(`Failed to delete excess artifact ${artifact.name}: ${error.message}`);
                }
              }
            }
            
            console.log(`Total deleted: ${deletedCount} artifacts`);