name: ğŸ§ª Build Check

# è½»é‡çº§æ„å»ºæ£€æŸ¥ï¼Œç”¨äºPRå’Œæ¨é€éªŒè¯
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

env:
  NODE_VERSION: 18

jobs:
  # å¿«é€Ÿæ„å»ºéªŒè¯
  build-check:
    name: ğŸ” Quick Build Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸšš Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: ğŸ” Lint check
        run: npm run lint || echo "Lint check completed with warnings"
        continue-on-error: true
        
      - name: ğŸ§ª Run tests
        run: npm test
        continue-on-error: true
        
      - name: ğŸ”§ Build application
        run: npm run build
        
      - name: âœ… Build success
        run: echo "âœ… Build completed successfully"

  # æ£€æŸ¥package.jsoné…ç½®
  package-check:
    name: ğŸ“‹ Package Configuration Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸšš Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ“‹ Check package.json
        run: |
          echo "=== Package Information ==="
          node -p "JSON.stringify(require('./package.json'), ['name', 'version', 'description', 'main', 'author'], 2)"
          
          echo ""
          echo "=== Build Configuration ==="
          node -p "JSON.stringify(require('./package.json').build, null, 2)" || echo "No build configuration found"
          
          echo ""
          echo "=== Build Scripts ==="
          node -p "JSON.stringify(require('./package.json').scripts, null, 2)"
          
      - name: ğŸ” Validate electron-builder config
        run: |
          node -e "
          const pkg = require('./package.json');
          const errors = [];
          
          // æ£€æŸ¥å¿…è¦å­—æ®µ
          if (!pkg.main) errors.push('Missing main field');
          if (!pkg.build) errors.push('Missing build configuration');
          if (!pkg.build.appId) errors.push('Missing build.appId');
          
          // æ£€æŸ¥æ„å»ºè„šæœ¬
          if (!pkg.scripts.build) errors.push('Missing build script');
          if (!pkg.scripts['package-win']) errors.push('Missing package-win script');
          if (!pkg.scripts['package-mac']) errors.push('Missing package-mac script');
          
          if (errors.length > 0) {
            console.log('âŒ Configuration errors:');
            errors.forEach(err => console.log('  - ' + err));
            process.exit(1);
          } else {
            console.log('âœ… Package configuration is valid');
          }
          "
          
  # æ£€æŸ¥èµ„æºæ–‡ä»¶
  assets-check:
    name: ğŸ“ Assets Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸšš Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ–¼ï¸ Check icon files
        run: |
          echo "=== Checking icon files ==="
          
          # æ£€æŸ¥Windowså›¾æ ‡
          if [ -f "assets/icons/win/logo_qz.ico" ]; then
            echo "âœ… Windows icon found"
            ls -la assets/icons/win/logo_qz.ico
          else
            echo "âš ï¸ Windows icon not found: assets/icons/win/logo_qz.ico"
          fi
          
          # æ£€æŸ¥macOSå›¾æ ‡
          if [ -f "assets/icons/mac/logo_qz.icns" ]; then
            echo "âœ… macOS icon found"
            ls -la assets/icons/mac/logo_qz.icns
          else
            echo "âš ï¸ macOS icon not found: assets/icons/mac/logo_qz.icns"
          fi
          
      - name: ğŸ“ Check build directories
        run: |
          echo "=== Build directories ==="
          ls -la || true
          
          echo ""
          echo "=== Source directories ==="
          ls -la src/ electron/ || true