name: ðŸš€ Build and Release Electron App

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, master, test1 ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master, test1 ]
  workflow_dispatch:

# çŽ¯å¢ƒå˜é‡
env:
  NODE_VERSION: 18
  ELECTRON_CACHE: ~/.cache/electron
  ELECTRON_BUILDER_CACHE: ~/.cache/electron-builder

jobs:
  # æž„å»ºå’Œæ‰“åŒ…ä»»åŠ¡
  build:
    name: ðŸ”¨ Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]
        
    steps:
      - name: ðŸšš Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ”§ Setup Python (for native modules)
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: ðŸŽ Install macOS dependencies
        if: matrix.os == 'macos-latest'
        run: |
          # å®‰è£…macOSæž„å»ºä¾èµ–
          python -m pip install setuptools
          
      - name: ðŸªŸ Install Windows dependencies
        if: matrix.os == 'windows-latest'
        run: |
          # å®‰è£…Windowsæž„å»ºä¾èµ–
          echo "Using built-in Windows build tools"
          
      - name: ðŸ§¹ Clean problematic files
        run: |
          # Remove any problematic files
          find . -name "nul" -type f -delete 2>/dev/null || true
          rm -f nul 2>/dev/null || true
          rm -f backend/nul 2>/dev/null || true
        shell: bash
        
      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: ðŸ§ª Run tests (if available)
        run: npm test || echo "Tests completed"
        continue-on-error: true
        
      - name: ðŸ”§ Build application
        run: npm run build
        
      - name: ðŸ“± Package Windows app
        if: matrix.os == 'windows-latest'
        run: npm run package-win
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEBUG: electron-builder
          
      - name: ðŸŽ Disable macOS code signing
        if: matrix.os == 'macos-latest'
        run: |
          # æ¸…é™¤æ‰€æœ‰å¯èƒ½å¯¼è‡´ç­¾åçš„çŽ¯å¢ƒå˜é‡
          unset CSC_LINK 2>/dev/null || true
          unset CSC_KEY_PASSWORD 2>/dev/null || true
          unset APPLE_ID 2>/dev/null || true
          unset APPLE_APP_SPECIFIC_PASSWORD 2>/dev/null || true
          unset APPLE_TEAM_ID 2>/dev/null || true
          # è®¾ç½®ç¦ç”¨ç­¾åçš„çŽ¯å¢ƒå˜é‡
          export CSC_IDENTITY_AUTO_DISCOVERY=false
          # æ¸…ç©ºkeychainä¸­çš„æ‰€æœ‰è¯ä¹¦
          security delete-keychain login.keychain 2>/dev/null || true
          echo "âœ… Code signing disabled"
          
      - name: ðŸŽ Package macOS app
        if: matrix.os == 'macos-latest'
        run: npm run package-mac
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEBUG: electron-builder
          
      - name: ðŸ“¤ Upload Windows artifacts
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            release/**/*.exe
            release/**/*.nsis.7z
            release/**/*.yml
          retention-days: 1
          
      - name: ðŸ“¤ Upload macOS artifacts
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            release/**/*.dmg
            release/**/*.zip
            release/**/*.yml
          retention-days: 1
        
  # åˆ›å»ºGitHub Releaseï¼ˆä»…åœ¨æŽ¨é€tagæ—¶è§¦å‘ï¼‰
  release:
    name: ðŸš€ Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: ðŸšš Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ“¥ Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: ./release-assets/windows/
          
      - name: ðŸ“¥ Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-build
          path: ./release-assets/macos/
          
      - name: ðŸ“‹ Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
          
      - name: ðŸ“ Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          cat > release_notes.md << EOF
          ## ðŸŽ‰ Interview Coder $VERSION
          
          ### ðŸ“¦ ä¸‹è½½å®‰è£…åŒ…
          
          #### Windows ç”¨æˆ·
          - **å®‰è£…åŒ…**: \`Interview-Coder-Windows-*.exe\` (æŽ¨è)
          - æ”¯æŒ Windows 10/11 (64ä½)
          
          #### macOS ç”¨æˆ·  
          - **DMGå®‰è£…åŒ…**: \`Interview-Coder-*.dmg\` (æŽ¨è)
          - **ZIPåŽ‹ç¼©åŒ…**: \`Interview-Coder-*.zip\`
          - æ”¯æŒ macOS 10.14+ (Intel å’Œ Apple Silicon)
          
          ### ðŸ”§ å®‰è£…è¯´æ˜Ž
          
          **Windows:**
          1. ä¸‹è½½ .exe å®‰è£…æ–‡ä»¶
          2. å³é”®é€‰æ‹©"ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
          3. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦ç‚¹å‡»"æ›´å¤šä¿¡æ¯" â†’ "ä»è¦è¿è¡Œ"
          4. å®‰è£…å®ŒæˆåŽä½¿ç”¨ \`Ctrl+B\` åˆ‡æ¢çª—å£å¯è§æ€§
          
          **macOS:**
          1. ä¸‹è½½ .dmg æ–‡ä»¶
          2. åŒå‡»æ‰“å¼€ï¼Œå°†åº”ç”¨æ‹–å…¥ Applications æ–‡ä»¶å¤¹
          3. é¦–æ¬¡è¿è¡Œéœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½®" â†’ "å®‰å…¨æ€§ä¸Žéšç§"ä¸­å…è®¸
          4. ä½¿ç”¨ \`Cmd+B\` åˆ‡æ¢çª—å£å¯è§æ€§
          
          ### âš¡ åŠŸèƒ½ç‰¹æ€§
          - ðŸ” æ™ºèƒ½ä»£ç åˆ†æžå’Œé¢˜ç›®è§£ç­”
          - ðŸŽ¯ éšèº«æ¨¡å¼ï¼Œé¢è¯•æ—¶ä¸è¢«å‘çŽ°  
          - ðŸ“¸ è‡ªåŠ¨æˆªå›¾å’Œå¤„ç†
          - ðŸŒ Webç«¯å’Œå®¢æˆ·ç«¯æ•°æ®åŒæ­¥
          - ðŸ”’ å®‰å…¨çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
          
          ### ðŸ› ï¸ å¿«æ·é”®
          - \`Ctrl+B\` / \`Cmd+B\`: åˆ‡æ¢çª—å£å¯è§æ€§
          - \`Ctrl+H\`: æˆªå›¾
          - \`Ctrl+Enter\`: å¤„ç†æˆªå›¾
          - \`Ctrl+Q\`: é€€å‡ºåº”ç”¨
          
          ### âš ï¸ é‡è¦æç¤º
          - è¯·ç¡®ä¿ç½‘ç»œè¿žæŽ¥æ­£å¸¸
          - é¦–æ¬¡ä½¿ç”¨éœ€è¦æ³¨å†Œè´¦æˆ·
          - å»ºè®®åœ¨æ­£å¼é¢è¯•å‰å…ˆç†Ÿæ‚‰æ“ä½œ
          
          ---
          **å®Œæ•´æ›´æ–°æ—¥å¿—è¯·æŸ¥çœ‹ [æäº¤åŽ†å²](https://github.com/\${{ github.repository }}/commits)**
          EOF
          
      - name: ðŸ·ï¸ List release assets
        run: |
          echo "=== Windows Build Assets ==="
          find ./release-assets/windows/ -type f -name "*.exe" -o -name "*.zip" | head -10
          echo ""
          echo "=== macOS Build Assets ==="
          find ./release-assets/macos/ -type f -name "*.dmg" -o -name "*.zip" | head -10
          
      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: Interview Coder ${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, '-') }}
          files: |
            ./release-assets/**/*.exe
            ./release-assets/**/*.dmg
            ./release-assets/**/*.zip
            ./release-assets/**/*.yml
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}