name: 🚀 Build and Release Electron App

# 触发条件
on:
  push:
    branches: [ main, master, test1 ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master, test1 ]
  workflow_dispatch:

# 环境变量
env:
  NODE_VERSION: 18
  ELECTRON_CACHE: ~/.cache/electron
  ELECTRON_BUILDER_CACHE: ~/.cache/electron-builder

jobs:
  # 构建和打包任务
  build:
    name: 🔨 Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]
        
    steps:
      - name: 🚚 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: 🟢 Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: 🔧 Setup Python (for native modules)
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: 🍎 Install macOS dependencies
        if: matrix.os == 'macos-latest'
        run: |
          # 安装macOS构建依赖
          python -m pip install setuptools
          
      - name: 🪟 Install Windows dependencies
        if: matrix.os == 'windows-latest'
        run: |
          # 安装Windows构建依赖
          echo "Using built-in Windows build tools"
          
      - name: 🧹 Clean problematic files
        run: |
          # Remove any problematic files
          find . -name "nul" -type f -delete 2>/dev/null || true
          rm -f nul 2>/dev/null || true
          rm -f backend/nul 2>/dev/null || true
        shell: bash
        
      - name: 📦 Install dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: 🧪 Run tests (if available)
        run: npm test || echo "Tests completed"
        continue-on-error: true
        
      - name: 🔧 Build application
        run: npm run build
        
      - name: 📱 Package Windows app
        if: matrix.os == 'windows-latest'
        run: npm run package-win
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEBUG: electron-builder
          
      - name: 🍎 Disable macOS code signing
        if: matrix.os == 'macos-latest'
        run: |
          # 清除所有可能导致签名的环境变量
          unset CSC_LINK 2>/dev/null || true
          unset CSC_KEY_PASSWORD 2>/dev/null || true
          unset APPLE_ID 2>/dev/null || true
          unset APPLE_APP_SPECIFIC_PASSWORD 2>/dev/null || true
          unset APPLE_TEAM_ID 2>/dev/null || true
          # 设置禁用签名的环境变量
          export CSC_IDENTITY_AUTO_DISCOVERY=false
          # 清空keychain中的所有证书
          security delete-keychain login.keychain 2>/dev/null || true
          echo "✅ Code signing disabled"
          
      - name: 🍎 Package macOS app
        if: matrix.os == 'macos-latest'
        run: npm run package-mac
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEBUG: electron-builder
          
      - name: 🏗️ Build completed successfully
        run: |
          echo "✅ Build completed! Artifacts temporarily disabled due to storage quota."
          echo "📦 Built files are located in the release/ directory"
          if [ -d "release" ]; then
            echo "📋 Generated files:"
            find release/ -type f -name "*.exe" -o -name "*.dmg" -o -name "*.zip" | head -10
          fi
          
      - name: 📋 Show generated files (instead of upload due to quota)
        run: |
          echo "🎉 构建成功完成！"
          echo ""
          echo "📦 生成的安装包文件："
          echo "================================"
          
          if [ -d "release" ]; then
            # 显示所有生成的文件
            find release/ -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.nsis.7z" \) -exec ls -lh {} \; | while read line; do
              echo "📄 $line"
            done
            
            echo ""
            echo "🔢 文件统计："
            echo "Windows .exe files: $(find release/ -name "*.exe" | wc -l)"
            echo "macOS .dmg files: $(find release/ -name "*.dmg" | wc -l)"  
            echo "macOS .zip files: $(find release/ -name "*.zip" | wc -l)"
            echo "Other files: $(find release/ -name "*.nsis.7z" -o -name "*.yml" | wc -l)"
            
            echo ""
            echo "📂 完整目录结构："
            ls -la release/ || true
            
            echo ""
            echo "⚠️  注意：由于GitHub存储配额限制，文件未上传"
            echo "📋 但构建已成功，上述文件已在CI环境中生成"
            echo "💡 等待存储配额恢复后可重新启用artifact上传"
            
            echo ""
            echo "🔗 如果能上传，下载链接将会是："
            if [ "${{ matrix.os }}" = "windows-latest" ]; then
              find release/ -name "*.exe" | while read file; do
                filename=$(basename "$file")
                echo "   Windows安装包: $filename"
              done
            fi
            
            if [ "${{ matrix.os }}" = "macos-latest" ]; then
              find release/ -name "*.dmg" | while read file; do
                filename=$(basename "$file")  
                echo "   macOS安装包: $filename"
              done
            fi
            
          else
            echo "❌ 错误：release目录不存在"
            echo "📋 可能的原因："
            echo "   - 构建过程中出现错误"
            echo "   - electron-builder配置问题"
            echo "   - 文件输出路径配置错误"
          fi
        
  # GitHub Release temporarily disabled due to artifacts storage issues
  # Will be re-enabled after storage quota is resolved