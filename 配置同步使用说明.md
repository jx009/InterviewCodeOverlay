# 配置同步功能使用说明

## 🎯 功能概述

现在客户端会在每次搜题前自动从Web端获取最新配置，确保使用正确的AI模型和设置。

## 🔄 工作流程

```
1. 用户在Web端修改配置 (AI模型、编程语言等)
2. 客户端开始搜题处理
3. 自动从Web端同步最新配置
4. 使用最新配置进行AI处理
```

## 📋 配置优先级

```
1. Web端最新配置 (最高优先级)
   ↓ 如果Web端不可用
2. Web端缓存配置 (备用)
   ↓ 如果Web端未登录
3. 本地配置 (回退)
   ↓ 如果本地配置无效
4. 默认配置 (紧急回退)
```

## 🚀 使用步骤

### 1. 启动服务
```bash
# 启动后端服务
cd backend
node server-simple.js

# 启动Web端 (另一个终端)
cd web
npm run dev
```

### 2. Web端配置
1. 打开 http://localhost:3000
2. 登录账号
3. 在设置中选择AI模型和编程语言
4. 配置会自动保存

### 3. 客户端使用
1. 启动客户端应用
2. 客户端会自动检测Web端登录状态
3. 进行截图和搜题操作
4. **每次搜题前会自动同步最新Web配置**

## 📊 配置同步日志

在客户端控制台中，你会看到类似的日志：

```
🔄 正在从Web端同步最新配置...
✅ 使用最新Web配置进行AI处理: {
  aiModel: "gemini-2.5-pro-preview-06-05",
  language: "go"
}
```

## 🛠️ 测试配置同步

运行测试脚本验证功能：

```bash
node 测试配置同步.js
```

## ⚠️ 故障排除

### 客户端显示"需要登录Web配置中心"
- **原因**: Web端未登录或共享会话过期
- **解决**: 在Web端重新登录

### 配置同步失败
- **原因**: 后端服务未启动或网络问题
- **解决**: 检查后端服务状态，重启后端

### 使用旧配置
- **原因**: Web端配置更新后，客户端仍使用缓存
- **解决**: 重新进行搜题操作，会自动同步最新配置

## 🔍 技术实现

### 配置同步机制
```typescript
// ProcessingHelper.ts - getEffectiveConfig()
private async getEffectiveConfig(): Promise<any> {
  // 1. 强制从Web端同步最新配置
  const freshWebConfig = await webAuthManager.syncUserConfig();
  
  // 2. 映射Web配置到处理格式
  return {
    apiProvider: this.mapAiModelToProvider(freshWebConfig.aiModel),
    extractionModel: freshWebConfig.aiModel,
    solutionModel: freshWebConfig.aiModel,
    debuggingModel: freshWebConfig.aiModel,
    language: freshWebConfig.language
  };
}
```

### 共享会话机制
```typescript
// WebAuthManager.ts - syncUserConfig()
public async syncUserConfig(): Promise<UserConfig | null> {
  // 方法1: 使用token直接获取
  if (this.tokens) {
    return await this.apiClient.get('/config');
  }
  
  // 方法2: 通过共享会话获取
  const session = await axios.get('/api/auth/shared-session');
  return await axios.get('/api/config', {
    headers: { 'Authorization': `Bearer ${session.accessToken}` }
  });
}
```

## ✅ 功能特点

- ✅ **实时同步**: 每次搜题前获取最新配置
- ✅ **自动回退**: 多层配置优先级保证可用性
- ✅ **详细日志**: 清晰显示配置来源和状态
- ✅ **错误处理**: 网络异常时的优雅降级
- ✅ **性能优化**: 智能缓存减少不必要的网络请求

现在你的客户端和Web端配置将始终保持同步！🎉 