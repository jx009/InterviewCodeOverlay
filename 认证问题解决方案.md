# 认证问题解决方案

## 🔍 问题诊断

通过测试，我们发现了以下情况：

1. **✅ 后端服务器正常运行** - 端口3001监听正常
2. **✅ 公开API正常** - 支付套餐等无需认证的API可以正常访问
3. **❌ 认证API需要登录** - 用户订单等需要认证的API返回"未提供认证令牌"
4. **✅ 登录API正常** - 登录端点 `/api/login` 存在且工作正常

## 💡 解决方案

### 方案一：在前端页面登录（推荐）

1. **启动前端服务**（如果未启动）：
   ```bash
   cd InterviewCodeOverlay/web
   npm start
   # 或
   yarn start
   ```

2. **访问登录页面**：
   - 打开浏览器访问 `http://localhost:3000/login`
   - 使用现有账号登录，或注册新账号

3. **注册新用户流程**：
   - 点击"注册"
   - 输入邮箱地址（确保可以接收邮件）
   - 输入用户名和密码
   - 点击发送验证码
   - 检查邮箱获取验证码
   - 输入验证码完成注册
   - 使用新账号登录

### 方案二：使用现有测试账号

系统中已存在测试账号：`test@example.com`

**需要重置密码**：
1. 在登录页面点击"忘记密码"
2. 输入邮箱：`test@example.com`
3. 接收重置码（需要配置SMTP服务）
4. 使用重置码设置新密码

### 方案三：快速测试（开发环境）

如果只是为了测试支付功能，我们可以创建一个测试用户：

```javascript
// 在backend目录运行
node -e "
const axios = require('axios');
const BASE_URL = 'http://localhost:3001/api';

async function createTestUser() {
  try {
    // 1. 发送验证码
    console.log('📧 发送验证码...');
    const verifyResponse = await axios.post(BASE_URL + '/mail_verify', {
      email: 'testuser@example.com',
      username: 'testuser'
    });
    
    if (verifyResponse.data.success) {
      console.log('✅ 验证码已发送，token:', verifyResponse.data.token);
      console.log('💡 请手动在邮箱中查看验证码，然后使用以下信息完成注册：');
      console.log('   邮箱: testuser@example.com');
      console.log('   用户名: testuser');
      console.log('   密码: 123456');
      console.log('   Token:', verifyResponse.data.token);
    }
  } catch (error) {
    console.log('结果:', error.response?.data || error.message);
  }
}

createTestUser();
"
```

## 🔧 配置SMTP服务（如需要邮箱验证）

如果需要邮箱验证功能，请在 `backend/.env` 文件中配置SMTP：

```env
# 邮件配置
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
EMAIL_FROM=your-email@gmail.com
```

## 🚀 测试支付功能步骤

1. **完成登录**
   - 确保已经登录并获得认证令牌
   - 检查浏览器控制台没有认证错误

2. **访问充值页面**
   - 前端：`http://localhost:3000/recharge`
   - 选择充值套餐

3. **创建支付订单**
   - 点击"微信支付"按钮
   - 系统会生成真实的微信支付二维码（不再是example.com）

4. **扫码支付**
   - 使用微信扫描二维码
   - 完成支付流程

## 📋 当前系统状态

- **✅ 后端服务器**：运行在 http://localhost:3001
- **✅ 微信支付配置**：已配置V2 API
- **✅ 数据库连接**：MySQL配置完成
- **✅ 前端轮询问题**：已修复
- **⚠️ 用户认证**：需要用户登录获取令牌

## 🛠️ 故障排除

### 如果仍然提示"未提供认证令牌"：

1. **检查浏览器localStorage**：
   ```javascript
   // 在浏览器控制台执行
   console.log('Token:', localStorage.getItem('token'));
   console.log('SessionId:', localStorage.getItem('sessionId'));
   ```

2. **检查网络请求头**：
   - 打开浏览器开发者工具
   - 查看Network标签
   - 确认请求头包含 `Authorization: Bearer <token>`

3. **清除缓存重新登录**：
   ```javascript
   // 在浏览器控制台执行
   localStorage.clear();
   // 然后重新登录
   ```

## 🎯 下一步

1. 完成用户登录获取认证令牌
2. 测试支付功能的完整流程
3. 确认二维码不再跳转到example.com
4. 验证支付订单创建和状态查询功能 