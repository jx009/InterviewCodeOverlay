# 登录问题修复说明

## 🔍 问题分析

用户遇到的问题：登录成功后无法显示主界面，仍然显示登录界面。

### 根本原因

1. **API路径不匹配**：
   - 后端提供：`POST /api/login`
   - 前端调用：`POST /api/auth/login`（错误）

2. **事件监听器错误**：
   - 前端使用了不存在的`onAuthStatusChanged`方法
   - 应该使用`onWebAuthStatus`方法

3. **认证状态同步问题**：
   - 登录成功后主进程发送了`web-auth-status`事件
   - 但前端没有正确监听和处理

## ✅ 修复内容

### 1. 修复API调用路径

**文件：`InterviewCodeOverlay/backend/public/login.html`**

```javascript
// 修复前
fetch(`${API_BASE}/api/auth/login`, {
    body: JSON.stringify({ username, password })
})

// 修复后  
fetch(`${API_BASE}/api/login`, {
    body: JSON.stringify({ email: username, password })
})
```

### 2. 修复事件监听器

**文件：`InterviewCodeOverlay/src/hooks/useWebAuth.ts`**

```typescript
// 修复前
if (window.electronAPI?.onAuthStatusChanged) {
  window.electronAPI.onAuthStatusChanged(handleAuthStatus)
}

// 修复后
const unsubscribeAuthStatus = window.electronAPI?.onWebAuthStatus?.(handleAuthStatus)
```

### 3. 增强OAuth回调检测

**文件：`InterviewCodeOverlay/electron/SimpleAuthManager.ts`**

- 增加了定期检查localStorage中sessionId的机制
- 延长了登录窗口关闭时间，给客户端更多时间获取sessionId

## 🧪 测试步骤

### 1. 启动系统

```bash
.\启动系统.bat
```

### 2. 启动客户端

```bash
.\stealth-run.bat
```

### 3. 显示客户端界面

按 `Ctrl+B` 使客户端可见

### 4. 触发登录流程

- 客户端会自动检测到未登录状态
- 显示登录提示通知
- 点击"立即登录"按钮

### 5. 完成登录

- 在弹出的登录窗口中输入邮箱密码
- 登录成功后窗口会自动关闭
- 客户端界面应该从登录界面切换到主功能界面

## 📋 期望的日志输出

### 成功登录时应该看到：

```
✅ 定期检查发现登录成功，获取到sessionId
✅ SessionId验证成功
✅ Token验证成功
✅ 认证状态验证成功
User authenticated: username
🔄 Auth status changed: {authenticated: true, user: {...}}
```

### 界面切换：

- 从 "需要登录" 界面
- 切换到 主功能界面（可以截图、处理题目等）

## 🔧 故障排除

### 如果登录后仍显示登录界面：

1. **检查控制台日志**：
   - 确认是否收到了`web-auth-status`事件
   - 确认`authenticated`状态是否为`true`

2. **手动刷新认证状态**：
   ```javascript
   // 在浏览器控制台执行
   window.electronAPI.webAuthStatus().then(console.log)
   ```

3. **重新构建应用**：
   ```bash
   cd InterviewCodeOverlay
   npm run build
   ```

### 如果sessionId获取失败：

1. **检查登录窗口localStorage**：
   - 登录成功后检查localStorage中是否有sessionId
   - 如果没有，说明后端登录API可能有问题

2. **检查后端日志**：
   - 确认是否成功调用了`/api/login`
   - 确认是否返回了正确的sessionId

## 🚀 功能验证

登录成功后，用户应该能够：

1. **看到主功能界面**
2. **使用截图功能**（`Ctrl+H`）
3. **处理截图队列**（`Ctrl+Enter`）
4. **访问设置**（`Ctrl+Shift+,`）
5. **移动窗口**（`Ctrl+方向键`）

## 📞 技术支持

如果问题仍然存在，请提供：

1. 完整的控制台日志
2. 网络请求日志（开发者工具 > Network 标签）
3. 后端服务日志
4. 具体的操作步骤

---

## 更新历史

- **2025-06-21**: 修复登录API路径不匹配问题
- **2025-06-21**: 修复事件监听器错误
- **2025-06-21**: 增强OAuth回调检测机制 