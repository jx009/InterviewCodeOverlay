# 邀请系统升级方案

## 📋 1. 当前系统分析

### 现有架构
- 用户表已有 `role` 字段（UserRole枚举：USER/ADMIN）
- 邀请记录表 `InviteRecord` 已存在
- 积分系统通过 `PointTransaction` 表
- 当前奖励：注册10积分，首充5%佣金

### 现有问题
- 奖励比例写死在代码中，无法动态调整
- 没有流量手角色区分
- 缺少现金佣金记录功能
- 界面不区分用户类型

## 🗄️ 2. 数据库表结构变更

### 2.1 新增邀请配置表
```sql
-- 邀请配置表（动态配置奖励比例）
CREATE TABLE invite_configs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  config_key VARCHAR(50) UNIQUE,  -- 配置键名
  config_value DECIMAL(10,4),     -- 积分数量或百分比
  description VARCHAR(200),       -- 配置说明
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 初始配置数据
INSERT INTO invite_configs VALUES
(1, 'default_register_reward', 30, '默认用户邀请注册奖励（积分）', 1, NOW(), NOW()),
(2, 'default_recharge_commission', 0.10, '默认用户被邀请人充值积分奖励比例', 1, NOW(), NOW()),
(3, 'traffic_register_reward', 30, '流量手邀请注册奖励（积分）', 1, NOW(), NOW()),
(4, 'traffic_recharge_commission', 0.10, '流量手被邀请人充值积分奖励比例', 1, NOW(), NOW()),
(5, 'traffic_money_commission', 0.20, '流量手现金佣金比例', 1, NOW(), NOW());
```

### 2.2 扩展用户表
```sql
-- 添加流量手标识
ALTER TABLE users ADD COLUMN is_traffic_agent BOOLEAN DEFAULT FALSE COMMENT '是否为流量手';

-- 添加索引
CREATE INDEX idx_users_traffic_agent ON users(is_traffic_agent);
```

### 2.3 新增佣金记录表
```sql
-- 佣金记录表（专门记录流量手的现金佣金）
CREATE TABLE commission_records (
  id INT PRIMARY KEY AUTO_INCREMENT,
  traffic_agent_id INT NOT NULL COMMENT '流量手ID',
  invitee_id INT NOT NULL COMMENT '被邀请用户ID',
  recharge_amount DECIMAL(10,2) NOT NULL COMMENT '充值金额',
  commission_rate DECIMAL(5,4) NOT NULL COMMENT '佣金比例',
  commission_amount DECIMAL(10,2) NOT NULL COMMENT '佣金金额',
  payment_order_id VARCHAR(50) COMMENT '关联的支付订单ID',
  status VARCHAR(20) DEFAULT 'PENDING' COMMENT '佣金状态：PENDING, PAID, CANCELLED',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (traffic_agent_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (invitee_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_traffic_agent_id (traffic_agent_id),
  INDEX idx_invitee_id (invitee_id),
  INDEX idx_status (status)
);
```

## 👥 3. 用户角色权限设计

### 角色分类
- **默认用户** (`is_traffic_agent = false`)
- **流量手** (`is_traffic_agent = true`) 
- **管理员** (`role = 'ADMIN'`)

### 权限矩阵
| 功能 | 默认用户 | 流量手 | 管理员 |
|------|---------|--------|--------|
| 查看积分奖励记录 | ✅ | ✅ | ✅ |
| 查看现金佣金记录 | ❌ | ✅ | ✅ |
| 配置奖励比例 | ❌ | ❌ | ✅ |
| 设置流量手身份 | ❌ | ❌ | ✅ |
| 查看全局邀请数据 | ❌ | ❌ | ✅ |

## 🎨 4. 前端界面结构设计

### 4.1 个人资料页面改造 (`ProfilePage.tsx`)

**现有标签页**：积分余额、消费历史、邀请管理

**新增标签页结构**：
```
个人资料
├── 积分余额 (原有)
├── 消费历史 (原有)  
├── 邀请管理
│   ├── 邀请链接生成 (原有)
│   ├── 积分奖励记录 (新：所有用户)
│   │   ├── 注册奖励：30积分/人
│   │   └── 充值奖励：被邀请人充值金额的10%积分
│   └── 佣金收入记录 (新：仅流量手可见)
│       ├── 佣金汇总统计
│       ├── 被邀请用户充值明细
│       └── 佣金收入趋势
└── 其他设置 (原有)
```

### 4.2 流量手专属界面组件
- **佣金汇总卡片**：总佣金、本月佣金、待结算佣金
- **充值明细表格**：用户名、充值金额、充值时间、佣金金额
- **佣金趋势图表**：按月/周统计的佣金收入

### 4.3 管理员界面改造 (`ManagerPage.tsx`)

**新增邀请配置面板**：
```
管理员面板
├── 用户管理 (原有)
├── 邀请配置 (新增)
│   ├── 奖励比例配置
│   │   ├── 默认用户配置（注册30积分、充值10%积分）
│   │   └── 流量手配置（注册30积分、充值10%积分、现金20%佣金）
│   ├── 流量手管理
│   │   ├── 设置/取消流量手身份
│   │   └── 流量手列表和统计
│   └── 邀请数据统计
│       ├── 全局邀请数据总览
│       ├── 用户邀请排行榜
│       └── 佣金支付管理
└── 其他管理功能 (原有)
```

## 🔧 5. 后端API接口设计

### 5.1 配置管理API
```typescript
GET  /api/invite/configs              // 获取邀请配置
PUT  /api/invite/configs              // 更新邀请配置（管理员）
GET  /api/users/traffic-agents        // 获取流量手列表（管理员）
PUT  /api/users/:id/traffic-agent     // 设置/取消流量手（管理员）
```

### 5.2 邀请数据API  
```typescript
GET  /api/invite/rewards/:userId      // 获取用户积分奖励记录
GET  /api/invite/commissions/:userId  // 获取流量手佣金记录
GET  /api/invite/summary/:userId      // 获取邀请数据汇总
GET  /api/admin/invite/overview       // 管理员邀请数据总览
GET  /api/admin/invite/users          // 管理员查看所有用户邀请情况
```

### 5.3 支付回调增强
```typescript
// 在支付成功回调中添加佣金计算逻辑
// 同时处理积分奖励和现金佣金记录
```

## ⚙️ 6. 核心业务逻辑调整

### 6.1 注册时触发逻辑
```typescript
async handleInviteRegistration(inviterId: string, newUserId: number) {
  // 1. 创建邀请记录到 invite_records 表
  // 2. 查询邀请人角色（默认用户 vs 流量手）
  // 3. 根据角色从配置表读取奖励数量（30积分）
  // 4. 发放积分奖励到 point_transactions 表
  // 5. 记录奖励到 invite_rewards 表
}
```

### 6.2 充值完成触发逻辑  
```typescript
async handleRechargeCommission(userId: number, rechargeAmount: number) {
  // 1. 查找邀请关系
  // 2. 判断邀请人角色
  // 3. 默认用户：发放充值金额10%的积分奖励
  // 4. 流量手：发放充值金额10%的积分奖励 + 记录20%现金佣金到 commission_records
  // 5. 更新邀请记录状态为ACTIVATED
}
```

### 6.3 配置读取服务
```typescript
class InviteConfigService {
  async getConfig(key: string): Promise<number>
  async updateConfig(key: string, value: number): Promise<void>
  async getAllConfigs(): Promise<InviteConfig[]>
}
```

## 📊 7. 界面展示逻辑

### 7.1 用户端界面

**默认用户看到**：
- 邀请链接生成
- 积分奖励记录：
  - 注册奖励：30积分/人
  - 充值奖励：被邀请人充值金额的10%积分

**流量手看到**：  
- 邀请链接生成
- 积分奖励记录：
  - 注册奖励：30积分/人  
  - 充值奖励：被邀请人充值金额的10%积分
- **新增佣金收入页面**：
  - 佣金汇总：总佣金、本月佣金、待结算
  - 充值明细：用户、金额、时间、佣金
  - 收入趋势图表

### 7.2 管理员界面
- **邀请配置管理**：
  - 默认用户奖励配置（注册30积分、充值10%积分）
  - 流量手奖励配置（注册30积分、充值10%积分、现金20%佣金）
- **流量手管理**：
  - 用户列表（可设置/取消流量手身份）
  - 流量手统计数据
- **邀请数据总览**：
  - 全平台邀请统计
  - 用户邀请排行
  - 佣金支付管理

## 🎯 8. 实施计划

### Phase 1：数据库结构 + 配置系统（1-2天）
1. 执行数据库迁移脚本
2. 创建 InviteConfigService
3. 修改 InviteService 读取动态配置

### Phase 2：角色判断 + 业务逻辑调整（2-3天）  
1. 修改注册和充值的邀请处理逻辑
2. 实现流量手佣金计算和记录
3. 创建相关API接口

### Phase 3：前端界面改造（3-4天）
1. 改造 ProfilePage 的邀请管理标签页
2. 创建流量手专属的佣金界面组件
3. 实现角色判断的界面展示逻辑

### Phase 4：管理员功能完善（2-3天）
1. 改造 ManagerPage 的邀请管理部分
2. 实现邀请配置管理界面
3. 实现流量手身份管理功能

## 🔍 9. 关键技术点

### 9.1 角色判断逻辑
```typescript
// 前端角色判断
const isTrafficAgent = user?.is_traffic_agent || false;
const isAdmin = user?.role === 'ADMIN';

// 后端角色验证
const user = await prisma.user.findUnique({
  where: { id: userId },
  select: { role: true, is_traffic_agent: true }
});
```

### 9.2 动态配置读取
```typescript
// 根据用户类型读取对应配置
const configKey = user.is_traffic_agent ? 'traffic_register_reward' : 'default_register_reward';
const rewardAmount = await configService.getConfig(configKey);
```

### 9.3 支付回调增强
```typescript
// 在现有支付成功回调中添加
async function handlePaymentSuccess(orderInfo) {
  // 原有逻辑：更新积分
  await updateUserPoints(orderInfo);
  
  // 新增逻辑：处理邀请佣金
  await handleInviteCommission(orderInfo.userId, orderInfo.amount);
}
```

## 🎨 10. UI/UX 设计要点

### 10.1 用户界面区分
- 默认用户：简洁的积分奖励展示
- 流量手：新增佣金收入专区，使用不同颜色主题区分

### 10.2 管理员界面
- 配置项使用表单组件，支持实时预览效果
- 流量手管理使用列表+开关组件
- 数据统计使用图表组件展示趋势

### 10.3 数据展示
- 积分数据：使用积分图标和蓝色主题
- 佣金数据：使用货币图标和绿色主题
- 统计图表：使用 Chart.js 或类似图表库

## 📝 11. 注意事项

### 11.1 兼容性
- 保持现有API接口不变，新增功能使用新接口
- 数据库变更使用增量迁移，不影响现有数据
- 前端界面渐进式升级，不破坏现有功能

### 11.2 安全性
- 流量手身份变更需要管理员权限
- 配置修改需要管理员权限并记录操作日志
- 佣金数据仅对相关用户可见

### 11.3 性能优化
- 配置数据使用缓存机制
- 大量邀请数据使用分页加载
- 统计数据可考虑定时计算缓存

## 🚀 12. 验收标准

### 12.1 功能验收
- [ ] 管理员可以动态配置所有奖励比例
- [ ] 管理员可以设置用户为流量手
- [ ] 默认用户看到积分奖励记录
- [ ] 流量手额外看到现金佣金记录
- [ ] 支付完成后正确计算和记录佣金

### 12.2 数据验收  
- [ ] 邀请记录正确写入 invite_records 表
- [ ] 积分奖励正确写入 point_transactions 表
- [ ] 流量手佣金正确写入 commission_records 表
- [ ] 配置数据正确写入 invite_configs 表

### 12.3 界面验收
- [ ] 不同角色看到对应的界面功能
- [ ] 管理员可以通过界面管理所有配置
- [ ] 数据展示准确且实时更新
- [ ] 界面响应速度良好

---

**总结**：这个方案将现有的单一邀请机制升级为支持双角色的动态配置系统，同时保持向后兼容性，为平台的邀请推广提供更灵活的管理工具。