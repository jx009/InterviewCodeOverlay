# 客户端登录问题修复说明

## 问题分析

您遇到的问题是：**客户端应该先登录才能触发搜题逻辑，但即使在Web界面中成功登录，客户端也检测不到登录状态。**

### 根本原因

原始的`SimpleAuthManager`只从本地配置文件(`config.json`)加载token，但没有检查`shared-session.json`文件中的Web端登录状态。

## 修复内容

### 1. 增强了token加载逻辑 (`SimpleAuthManager.ts`)

- ✅ **新增共享会话检测**：`loadTokenFromSharedSession()`方法
- ✅ **自动会话过期检查**：检查`shared-session.json`中的`expiresAt`
- ✅ **自动token同步**：将共享会话的token保存到本地配置

### 2. 改进了认证初始化流程

- ✅ **新增`initializeAuth()`方法**：综合检查本地token和Web会话
- ✅ **智能状态检测**：优先使用本地token，无效时检查Web端会话
- ✅ **后端会话验证**：通过`/api/auth/web-session-status`API检查活跃会话

### 3. 优化了OAuth登录回调

- ✅ **自动状态刷新**：登录成功后自动检查并加载共享会话
- ✅ **状态同步延迟**：给Web端足够时间创建共享会话文件

### 4. 修复了启动检查逻辑

- ✅ **全面认证检查**：应用启动时使用`initializeAuth()`替代简单的token验证
- ✅ **窗口创建后再检查**：窗口显示后重新验证认证状态

## 工作流程

### 正常登录流程
1. **Web端登录** → 创建`shared-session.json`
2. **客户端启动** → 检查本地token → 检查共享会话 → 自动登录
3. **搜题可用** → 用户可以直接使用搜题功能

### 新用户登录流程
1. **客户端启动** → 检测未登录状态 → 显示登录提示
2. **用户点击登录** → 打开OAuth窗口 → Web端登录
3. **登录成功** → 创建共享会话 → 客户端自动同步 → 搜题可用

## 使用方法

### 方法1：使用修复版启动脚本（推荐）
```batch
stealth-run-fixed.bat
```

### 方法2：手动验证修复
1. **确保后端运行**：
   ```
   cd backend
   node server-simple.js
   ```

2. **在浏览器中登录**：
   - 访问：`http://localhost:3001/login`
   - 用户名：`123456@test.com`
   - 密码：任意（如：`123456`）

3. **启动客户端**：
   ```
   npm run build
   npx electron ./dist-electron/main.js
   ```

4. **验证状态**：
   - 按`Ctrl+B`显示窗口
   - 应该显示"欢迎回来，123456！"而不是登录提示

## 技术细节

### 关键代码修改

1. **共享会话检测**：
```typescript
private loadTokenFromSharedSession(): void {
  const sharedSessionPath = path.join(process.cwd(), 'shared-session.json')
  if (fs.existsSync(sharedSessionPath)) {
    const sharedSession = JSON.parse(fs.readFileSync(sharedSessionPath, 'utf8'))
    // 检查过期时间并加载token
  }
}
```

2. **认证初始化**：
```typescript
public async initializeAuth(): Promise<boolean> {
  this.loadStoredToken() // 包含共享会话检查
  if (this.token) {
    return await this.isAuthenticated()
  }
  const hasWebSession = await this.checkWebSession()
  // ...
}
```

### API集成

- `GET /api/auth/web-session-status` - 检查Web端会话状态
- `GET /api/auth/shared-session` - 获取共享会话token
- `POST /api/auth/create-shared-session` - 创建共享会话

## 验证方法

### 1. 检查共享会话文件
```powershell
Get-Content shared-session.json | ConvertFrom-Json
```

### 2. 验证后端会话状态
```powershell
Invoke-RestMethod -Uri 'http://localhost:3001/api/auth/web-session-status' -Method GET
```

### 3. 查看客户端日志
启动后在控制台查看：
- `✅ 从共享会话成功加载token`
- `✅ 用户已认证: [用户名]`

## 故障排除

### 如果仍然无法登录

1. **删除旧的会话文件**：
   ```batch
   del shared-session.json
   del config.json
   ```

2. **重新登录**：
   - 浏览器访问：`http://localhost:3001/login`
   - 使用正确凭据登录

3. **重启客户端**：
   ```batch
   stealth-run-fixed.bat
   ```

### 常见问题

- **Q**: 为什么需要Web端登录？
- **A**: 共享会话机制确保Web配置和客户端设置同步，提供统一的用户体验。

- **Q**: token会过期吗？
- **A**: 是的，token有效期为15分钟，但有7天的refresh token。过期时会自动清理。

- **Q**: 如何确认修复生效？
- **A**: 启动客户端后按Ctrl+B，应该看到欢迎信息而不是登录提示。

## 结论

经过以上修复，您的客户端现在能够：
- ✅ 自动检测Web端的登录状态
- ✅ 无缝同步认证信息
- ✅ 在登录成功后立即启用搜题功能
- ✅ 提供友好的登录状态提示

请使用`stealth-run-fixed.bat`启动应用，享受修复后的流畅体验！ 